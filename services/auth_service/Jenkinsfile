pipeline {
    agent any

    environment {
        IMAGE_NAME   = 'auth-service'
        K8S_MANIFEST = 'k8s/auth-service.yaml'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    echo "Building Docker image: ${imageTag}"

                    bat "docker build -t ${imageTag} -f services/auth_service/Dockerfile ."
                }
            }
        }

        stage('Load Image into Minikube') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    echo "Loading image into Minikube: ${imageTag}"

                    bat "minikube image load ${imageTag}"
                }
            }
        }

        stage('Ensure Minikube is Running') {
            steps {
                script {
                    echo "Checking Minikube status (starting it if needed)..."
                    // In Windows CMD, "cmd1 || cmd2" = run cmd2 if cmd1 fails
                    bat "minikube status || minikube start"
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    echo "Applying Kubernetes manifest: ${K8S_MANIFEST}"

                    // Use minikube's kubectl wrapper
                    bat "minikube kubectl -- apply -f ${K8S_MANIFEST}"

                    echo "Updating deployment image to: ${imageTag}"
                    bat "minikube kubectl -- set image deployment/auth-service auth-service=${imageTag} --record"

                    echo "Waiting for rollout to complete..."
                    bat "minikube kubectl -- rollout status deployment/auth-service"
                }
            }
        }

        stage('Debug - Check User Context') {
            steps {
                script {
                    echo "Checking Jenkins user context..."
                    bat "whoami"
                    bat "echo %USERPROFILE%"
                    bat "dir %USERPROFILE%\\.minikube"
                }
            }
        }

    }


    post {
        success {
            echo "Auth service successfully built and deployed to Minikube! ✅"
        }
        failure {
            echo "❌ Build or deployment failed. Check the stage logs above."
        }
    }

}
