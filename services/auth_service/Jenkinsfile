pipeline {
    agent any

    environment {
        IMAGE_NAME   = 'auth-service'
        K8S_MANIFEST = 'k8s/auth-service.yaml'
    }

    stages {

        stage('Debug - User Context') {
            steps {
                script {
                    echo "=== Checking Jenkins User Context ==="
                    bat "whoami"
                    bat "echo Current User Profile: %USERPROFILE%"
                    bat "echo Jenkins Home: %JENKINS_HOME%"
                }
            }
        }

        stage('Debug - Minikube Config') {
            steps {
                script {
                    echo "=== Checking Minikube Configuration ==="
                    bat """
                        echo Checking for .minikube folder...
                        dir %USERPROFILE%\\.minikube 2>nul || echo .minikube folder NOT FOUND in %USERPROFILE%
                        
                        echo.
                        echo Checking for .kube folder...
                        dir %USERPROFILE%\\.kube 2>nul || echo .kube folder NOT FOUND in %USERPROFILE%
                    """
                }
            }
        }

        stage('Debug - Docker Access') {
            steps {
                script {
                    echo "=== Checking Docker Access ==="
                    bat "docker --version"
                    bat "docker ps"
                }
            }
        }

        stage('Debug - Minikube Access') {
            steps {
                script {
                    echo "=== Checking Minikube Access ==="
                    bat "minikube version"
                    bat "minikube status || echo Minikube status check failed"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    echo "Building Docker image: ${imageTag}"

                    bat "docker build -t ${imageTag} -f services/auth_service/Dockerfile ."
                }
            }
        }

        stage('Ensure Minikube Running') {
            steps {
                script {
                    echo "Ensuring Minikube is running..."
                    bat "minikube status || minikube start"
                }
            }
        }

        stage('Load Image to Minikube') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    echo "Loading image into Minikube: ${imageTag}"
                    bat "minikube image load ${imageTag}"
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    echo "Applying Kubernetes manifest: ${K8S_MANIFEST}"

                    // Use minikube's kubectl wrapper
                    bat "minikube kubectl -- apply -f ${K8S_MANIFEST}"

                    echo "Updating deployment image to: ${imageTag}"
                    bat "minikube kubectl -- set image deployment/auth-service auth-service=${imageTag}"

                    echo "Waiting for rollout to complete..."
                    bat "minikube kubectl -- rollout status deployment/auth-service"
                }
            }
        }

        stage('Debug - Check User Context') {
            steps {
                script {
                    echo "Checking Jenkins user context..."
                    bat "whoami"
                    bat "echo %USERPROFILE%"
                    bat "dir %USERPROFILE%\\.minikube"
                }
            }
        }

    }


    post {
        success {
            echo "✅ Auth service successfully built and deployed!"
        }
        failure {
            echo "❌ Build failed. Check the logs above."
        }
    }

}
